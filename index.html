<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <title>เปิดบ้านวิชาการ Open House 2026 - PPW คุณธรรมนำความรู้ สู่อาชีพที่ยั่งยืน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #fdf6e3; }
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap');
        
        /* Theme Adventure */
        .map-bg {
            background-color: #f4ebd0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }
        .treasure-btn {
            background: linear-gradient(180deg, #d4af37 0%, #aa7c11 100%);
            border: 2px solid #5c3a21;
            box-shadow: 0 4px 0 #5c3a21, 0 8px 15px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transition: all 0.1s;
        }
        .treasure-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0px 0 #5c3a21, 0 2px 5px rgba(0,0,0,0.3);
        }

        .pin-dot.active { background-color: #8b5a2b; transform: scale(1.2); }
        .numpad-btn:active { background-color: #e5e7eb; transform: scale(0.95); }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
        .animate-pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        #reader video, #login-reader video { object-fit: cover; border-radius: 1rem; width: 100% !important; height: 100% !important; }
        #reader, #login-reader { border: none !important; width: 100%; height: 100%; }
        .loading-overlay { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="h-screen overflow-hidden text-amber-950">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // 1. ใส่ URL ของ Web App Google Apps Script ของคุณที่นี่
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwNjqLH7pMgeA4pFEMt4ujczxUhiUND7CShyKAkyzx3CjdHYeRg1rbq6NqAUw-R2WE8UQ/exec";
        const ADMIN_PIN = "130240";

        // 2. ฟังก์ชันหลักสำหรับเรียก API ไปยัง Google Apps Script (ใช้แทน google.script.run)
        const apiCall = async (action, payload = {}) => {
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // ใช้ text/plain เพื่อเลี่ยงปัญหา CORS
                    body: JSON.stringify({ action: action, data: payload })
                });
                return await response.json();
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        };

        function App() {
            const [view, setView] = useState('landing');
            const [user, setUser] = useState(null);
            const [staffData, setStaffData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [alertMsg, setAlertMsg] = useState('');
            const [appUrl, setAppUrl] = useState('');

            useEffect(() => {
                const currentUrl = window.location.href.split('?')[0];
                setAppUrl(currentUrl);

                const urlParams = new URLSearchParams(window.location.search);
                const pinFromUrl = urlParams.get('pin');

                if (pinFromUrl) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                    handlePinSubmit(pinFromUrl);
                } else {
                    try {
                        const storedUser = localStorage.getItem('pk_user_session');
                        const storedStaff = localStorage.getItem('pk_staff_session');
                        if (storedStaff) { setStaffData(JSON.parse(storedStaff)); setView('staff'); } 
                        else if (storedUser) { setUser(JSON.parse(storedUser)); setView('student'); }
                    } catch (e) {}
                }
            }, []);

            const handleLogout = () => {
                localStorage.removeItem('pk_user_session'); localStorage.removeItem('pk_staff_session');
                setUser(null); setStaffData(null); setView('landing');
            };

            const handlePinSubmit = async (pin) => {
                if (pin === ADMIN_PIN) { setView('admin'); return; }
                setLoading(true); setAlertMsg('');
                
                try {
                    // เรียก API แทน google.script.run
                    const res = await apiCall('loginWithPin', { pin: pin });
                    setLoading(false);
                    if (res.status === 'success') {
                        localStorage.setItem(res.role === 'staff' ? 'pk_staff_session' : 'pk_user_session', JSON.stringify(res.data));
                        if (res.role === 'staff') { setStaffData(res.data); setView('staff'); }
                        else { setUser(res.data); setView('student'); }
                    } else { 
                        setAlertMsg(res.message || "ไม่พบรหัส PIN นี้ในระบบ"); 
                    }
                } catch (error) {
                    setLoading(false);
                    setAlertMsg("ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้ (กำลังใช้โหมดทดลอง)");
                    // โหมด Demo หากเชื่อมต่อไม่ได้
                    setTimeout(() => {
                        setUser({ id: 'U123', name: 'นักผจญภัย (Demo)', school: 'จำลอง', pin: pin }); setView('student');
                        setAlertMsg('');
                    }, 1500);
                }
            };

            const LoginScanner = () => {
                const scannerRef = useRef(null);

                useEffect(() => { 
                    const s = new Html5Qrcode("login-reader"); 
                    scannerRef.current = s; 
                    s.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                        (txt) => {
                            s.pause();
                            let extractPin = txt;
                            try {
                                if (txt.includes('pin=')) { 
                                    const url = new URL(txt); extractPin = url.searchParams.get('pin'); 
                                } else { 
                                    const d = JSON.parse(txt); extractPin = d.pin || d.id; 
                                }
                            } catch(e) {}
                            
                            if (extractPin && extractPin.length >= 4) { 
                                handlePinSubmit(extractPin);
                            } else { 
                                setAlertMsg("รูปแบบ QR Code ไม่ถูกต้อง"); 
                                setTimeout(() => { setAlertMsg(''); s.resume(); }, 2000); 
                            }
                        }, 
                        (e) => {}
                    ).catch(e => { console.warn("Camera start error:", e); }); 
                    return () => { if(s.isScanning) s.stop().catch(e => console.warn(e)); }; 
                }, []);

                return (
                    <div className="h-full bg-gray-900 flex flex-col relative text-white animate-slide-in">
                        {alertMsg && <div className="absolute top-0 w-full p-4 bg-red-600 text-white text-center z-50 text-sm font-bold shadow-md">{alertMsg}</div>}
                        <div className="p-4 bg-[#8b5a2b] flex items-center shadow-lg border-b-4 border-[#5c3a21] z-10">
                            <button onClick={() => setView('landing')} className="text-amber-200 hover:text-white font-bold p-2"><i className="fa-solid fa-arrow-left"></i> กลับ</button>
                            <h2 className="flex-1 text-center font-bold text-lg pr-8">สแกนเพื่อเข้าระบบ</h2>
                        </div>
                        <div className="flex-1 flex flex-col justify-center items-center p-6 relative">
                            {loading && <div className="absolute inset-0 bg-black/50 z-20 flex items-center justify-center"><div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div></div>}
                            <div className="bg-gray-800 p-2 rounded-3xl shadow-2xl border-4 border-[#8b5a2b] w-full max-w-sm overflow-hidden h-72 relative">
                                <div id="login-reader" className="w-full bg-black rounded-2xl overflow-hidden h-full"></div>
                            </div>
                            <p className="mt-8 text-amber-200 text-center text-sm font-medium bg-black/40 p-4 rounded-xl">
                                <i className="fa-solid fa-camera mr-2"></i> สแกน QR Code ที่ได้รับเพื่อเข้าสู่ระบบ
                            </p>
                        </div>
                    </div>
                );
            };

            const PinPad = ({ onComplete, onBack }) => {
                const [pin, setPin] = useState("");
                const handlePress = (num) => {
                    if (pin.length < 6) {
                        const newPin = pin + num; setPin(newPin);
                        if (newPin === ADMIN_PIN || newPin.length === 6) onComplete(newPin);
                    }
                };
                return (
                    <div className="flex flex-col h-full bg-[#fdf6e3] animate-slide-in relative">
                        {loading && <div className="absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center"><div className="w-12 h-12 border-4 border-amber-800 border-t-transparent rounded-full animate-spin"></div><p className="mt-4 font-bold text-amber-900">กำลังตรวจสอบ...</p></div>}
                        <div className="flex-1 flex flex-col items-center justify-center p-6"><i className="fa-solid fa-compass text-4xl text-amber-800 mb-4 animate-float"></i><h2 className="text-2xl font-bold text-amber-900 mb-2">กรอกรหัส 6 หลัก</h2><p className="text-amber-700/70 text-sm mb-6">รหัสลับจากแผนที่ของคุณ</p><div className="flex gap-4 mb-8 h-8">{[...Array(6)].map((_, i) => <div key={i} className={`w-4 h-4 rounded-full border-2 border-amber-800 pin-dot ${i < pin.length ? 'bg-amber-800 active' : 'bg-transparent'}`}></div>)}</div></div>
                        <div className="bg-white p-6 pb-10 rounded-t-3xl shadow-[0_-10px_20px_rgba(139,90,43,0.1)] border-t border-amber-100"><div className="grid grid-cols-3 gap-4 max-w-sm mx-auto">{[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => <button key={num} onClick={() => handlePress(num)} className="numpad-btn h-16 rounded-2xl bg-[#fdf6e3] text-2xl font-bold text-amber-900 shadow border border-amber-200">{num}</button>)}<button onClick={onBack} className="numpad-btn h-16 rounded-2xl text-amber-600/60 font-medium">ย้อนกลับ</button><button onClick={() => handlePress(0)} className="numpad-btn h-16 rounded-2xl bg-[#fdf6e3] text-2xl font-bold text-amber-900 shadow border border-amber-200">0</button><button onClick={() => setPin(pin.slice(0, -1))} className="numpad-btn h-16 rounded-2xl text-red-500"><i className="fa-solid fa-delete-left text-xl"></i></button></div></div>
                    </div>
                );
            };

            const Landing = () => (
                <div className="h-full flex flex-col items-center justify-center map-bg text-amber-900 p-6 relative overflow-hidden animate-slide-in">
                    <div className="z-10 text-center w-full max-w-md mt-6">
                        <div className="bg-white/70 backdrop-blur-md p-8 rounded-3xl mb-8 shadow-xl border-2 border-amber-800/20 relative">
                            <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-[#8b5a2b] text-white w-12 h-12 flex items-center justify-center rounded-full border-4 border-[#fdf6e3] shadow-lg"><i className="fa-solid fa-map"></i></div>
                            <img src="https://pakprak.ac.th/wp-content/uploads/2021/10/BackStage-copy-scaled.jpg" className="h-32 object-contain mx-auto mb-4 filter drop-shadow-md rounded-xl" />
                            <h1 className="text-3xl font-black mb-1 text-amber-900 tracking-tight">เปิดบ้านวิชาการ Open House 2026</h1>
                            <p className="text-sm text-amber-700 font-bold tracking-widest uppercase">PPW คุณธรรมนำความรู้ สู่อาชีพที่ยั่งยืน</p>
                        </div>
                        <div className="space-y-3 pb-8">
                            <button onClick={() => setView('login-scan')} className="w-full bg-[#5c3a21] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-[#3d2616] transition transform hover:scale-[1.02] flex items-center justify-center gap-3"><i className="fa-solid fa-qrcode"></i> สแกน QR Code เข้าระบบ</button>
                            <button onClick={() => setView('login-pin')} className="w-full bg-[#8b5a2b] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-[#704822] transition transform hover:scale-[1.02] flex items-center justify-center gap-3"><i className="fa-solid fa-keyboard"></i> กรอกรหัสเข้าสู่ระบบ (PIN)</button>
                            <button onClick={() => setView('register')} className="w-full bg-transparent text-amber-800 border-2 border-amber-800 py-4 rounded-xl font-bold text-lg shadow-sm hover:bg-amber-800/10 transition transform hover:scale-[1.02] flex items-center justify-center gap-3"><i className="fa-solid fa-feather-pointed"></i> ลงทะเบียนรับ QR Code เข้างาน</button>
                            <p className="text-sm text-amber-700 mt-4">ท่านสามารถนำ QR Code ให้เจ้าหน้าที่ประจำบูธสแกนเมื่อเข้าร่วมบูธ</p>
                            <p className="text-sm text-amber-700 ">เพื่อรับเกียรติบัตร เมื่อเข้าร่วมครบทุกบูธ</p>
                        </div>
                    </div>
                </div>
            );

            const Register = () => {
                const handleSubmit = async (e) => {
                    e.preventDefault(); 
                    const fd = new FormData(e.target);
                    setLoading(true); setAlertMsg('');
                    
                    const newUser = { id: Math.random().toString(36).substr(2, 9), name: fd.get('fullname'), school: fd.get('school') };
                    
                    try {
                        const res = await apiCall('registerUser', { user: newUser, appUrl: appUrl });
                        setLoading(false);
                        if (res.status === 'success') { 
                            setUser(res.userData); 
                            localStorage.setItem('pk_user_session', JSON.stringify(res.userData)); 
                            setView('student'); 
                        } else { 
                            setAlertMsg(res.message || "เกิดข้อผิดพลาดในการลงทะเบียน"); 
                        }
                    } catch (error) {
                        setLoading(false);
                        setAlertMsg("โหมด Demo: สร้างรหัสจำลองให้แล้ว");
                        setTimeout(() => { 
                            newUser.pin = "123456"; setUser(newUser); setView('student'); 
                        }, 1000); 
                    }
                };
                return (
                    <div className="h-full flex flex-col map-bg animate-slide-in relative">
                        {alertMsg && <div className={`absolute top-0 left-0 w-full p-3 z-50 text-center font-bold text-white ${alertMsg.includes('Demo') ? 'bg-amber-500' : 'bg-red-600'}`}>{alertMsg}</div>}
                        {loading && <div className="absolute inset-0 bg-white/60 backdrop-blur z-40 flex items-center justify-center"><div className="w-10 h-10 border-4 border-amber-800 border-t-transparent rounded-full animate-spin"></div></div>}
                        <div className="p-4 bg-white/50 backdrop-blur border-b border-amber-800/10"><button onClick={() => setView('landing')} className="text-amber-800 font-bold"><i className="fa-solid fa-arrow-left"></i> กลับไปจุดเริ่มต้น</button></div>
                        <div className="p-6 flex-1 overflow-y-auto">
                            <h2 className="text-2xl font-black text-amber-900 mb-2">ลงนามผู้ท้าทาย</h2>
                            <p className="text-amber-700/80 mb-6 text-sm">กรอกข้อมูลเพื่อรับรหัสแผนที่และ QR Code ของคุณ (ระบบจะสร้างให้ 6 หลัก)</p>
                            <form onSubmit={handleSubmit} className="space-y-5 bg-white p-6 rounded-2xl shadow-xl border border-amber-100">
                                <div><label className="block text-sm font-bold text-amber-900 mb-2"><i className="fa-solid fa-user-astronaut mr-2"></i>นามแฝง / ชื่อ-สกุล</label><input required name="fullname" className="w-full p-4 rounded-xl border-2 border-amber-100 bg-[#fdf6e3] focus:border-amber-500 focus:outline-none transition" /></div>
                                <div><label className="block text-sm font-bold text-amber-900 mb-2"><i className="fa-solid fa-school mr-2"></i>สังกัด / โรงเรียน</label><input required name="school" className="w-full p-4 rounded-xl border-2 border-amber-100 bg-[#fdf6e3] focus:border-amber-500 focus:outline-none transition" /></div>
                                <button type="submit" className="w-full bg-[#8b5a2b] text-white py-4 rounded-xl font-bold shadow-lg hover:bg-[#704822] mt-4"><i className="fa-solid fa-wand-magic-sparkles mr-2"></i>สร้างรหัสแผนที่</button>
                            </form>
                        </div>
                    </div>
                );
            };

            const StudentDashboard = () => {
                const [allBooths, setAllBooths] = useState([]);
                const [visited, setVisited] = useState([]);
                const [windowWidth, setWindowWidth] = useState(window.innerWidth);
                const [missionComplete, setMissionComplete] = useState(false);
                const [showCertModal, setShowCertModal] = useState(false);
                const [certUrl, setCertUrl] = useState('');
                const [isGeneratingCert, setIsGeneratingCert] = useState(false);

                // ดึงรายชื่อบูธ
                useEffect(() => {
                    const handleResize = () => setWindowWidth(window.innerWidth); window.addEventListener('resize', handleResize);
                    
                    apiCall('getPublicBooths')
                        .then(res => setAllBooths(res.filter(b => b && b.id)))
                        .catch(() => {
                            // Demo Data ถ้าเชื่อมต่อไม่ได้
                            setAllBooths([{id:'b1', name:'Science', desc:'ห้องทดลองลี้ลับ'}, {id:'b2', name:'Math', desc:'ปริศนาตัวเลข'}, {id:'b3', name:'Art', desc:'หุบเขาศิลปะ'}]);
                        });
                        
                    return () => window.removeEventListener('resize', handleResize);
                }, []);

                // เช็คสถานะการเข้าบูธเรื่อยๆ
                useEffect(() => {
                    const fetchStatus = () => { 
                        apiCall('getCertificates', { pin: user.pin })
                            .then(res => { if(Array.isArray(res)) setVisited(res); })
                            .catch(e => console.log('Polling error:', e));
                    };
                    fetchStatus(); const i = setInterval(fetchStatus, 5000); return () => clearInterval(i);
                }, [user.pin]);

                useEffect(() => { if (allBooths.length > 0 && visited.length >= allBooths.length) setMissionComplete(true); }, [allBooths, visited]);

                const getBoothStatus = (bName) => visited.find(v => v.boothName === bName);

                const handleClaimCertificate = async () => {
                    setIsGeneratingCert(true);
                    try {
                        const res = await apiCall('generateMasterCertificate', { pin: user.pin });
                        setIsGeneratingCert(false);
                        if(res.status === 'success') { 
                            setCertUrl(res.url); setShowCertModal(true); 
                        } else { 
                            alert(res.message || 'เกิดข้อผิดพลาดในการสร้างเกียรติบัตร'); 
                        }
                    } catch(error) {
                        setTimeout(() => { setIsGeneratingCert(false); setCertUrl('https://example.com/cert.pdf'); setShowCertModal(true); }, 2000);
                    }
                };

                const qrPayload = `${appUrl}?pin=${user.pin}`;

                return (
                    <div className="h-full map-bg flex flex-col relative overflow-hidden text-amber-950 font-sans">
                        <div className="bg-[#8b5a2b] p-4 shadow-lg z-20 border-b-4 border-[#5c3a21] text-white">
                            <div className="flex justify-between items-center"><div className="flex gap-3 items-center"><div className="w-12 h-12 rounded-full bg-[#fdf6e3] text-[#8b5a2b] flex items-center justify-center font-black text-xl border-2 border-[#5c3a21] shadow-inner"><i className="fa-solid fa-user-ninja"></i></div><div><div className="font-bold text-lg">{user.name}</div><div className="text-xs text-amber-200/80 tracking-widest uppercase">รหัสแผนที่: <span className="text-white font-bold">{user.pin}</span></div></div></div><button onClick={handleLogout} className="text-amber-200 hover:text-white bg-black/20 w-10 h-10 rounded-full flex items-center justify-center"><i className="fa-solid fa-person-walking-arrow-right"></i></button></div>
                            <div className="mt-4 flex items-center gap-3">
                                <div className="text-xs font-bold uppercase tracking-widest text-amber-200">ความคืบหน้า</div>
                                <div className="flex-1 bg-black/30 h-3 rounded-full overflow-hidden border border-[#5c3a21]"><div className="bg-[#d4af37] h-full transition-all duration-1000 relative" style={{width: `${(visited.length/Math.max(1,allBooths.length))*100}%`}}><div className="absolute inset-0 bg-white/20 w-full h-full" style={{backgroundImage:'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px)'}}></div></div></div>
                                <div className="text-sm font-black text-[#d4af37] drop-shadow-md">{visited.length}/{allBooths.length}</div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 pb-32 relative">
                            <svg className="absolute top-0 left-0 w-full pointer-events-none" style={{height: `${Math.max(100, allBooths.length * 20 + 20)}%`}}>
                                <path d={`M ${windowWidth/2} 40 `+allBooths.map((_,i)=>{const y=i*140+100;const x=i%2===0?windowWidth*0.2:windowWidth*0.8;return `S ${windowWidth/2} ${y-70}, ${x} ${y}`;}).join(' ')} fill="none" stroke="#8b5a2b" strokeWidth="4" strokeDasharray="10 10" strokeLinecap="round" opacity="0.3" />
                            </svg>
                            
                            <div className="space-y-16 py-8 relative z-10">
                                {allBooths.map((b,i)=>{
                                    const s=getBoothStatus(b.name); const isLeft=i%2===0;
                                    return (
                                        <div key={b.id} className={`flex items-center ${isLeft?'flex-row':'flex-row-reverse'} justify-center relative`}>
                                            <div className={`absolute ${isLeft?'left-4 text-left':'right-4 text-right'} top-1/2 -translate-y-1/2 w-40 bg-white/70 backdrop-blur p-3 rounded-xl border border-amber-900/10 shadow-sm`}>
                                                <div className={`font-black text-sm ${s?'text-green-700':'text-amber-900'}`}>{b.name}</div>
                                                <div className="text-xs text-amber-700/80 leading-tight mt-1 font-medium">{b.desc}</div>
                                            </div>
                                            <div className="relative group mx-4">
                                                <div className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl shadow-xl z-20 relative transition-all duration-500 border-4 ${s?'bg-green-100 border-green-500 text-green-600 scale-110 shadow-green-500/30':'bg-[#fdf6e3] border-[#8b5a2b] text-[#8b5a2b] opacity-90'}`}>
                                                    {s ? <i className="fa-solid fa-flag text-3xl animate-bounce" style={{transformOrigin:'bottom left'}}></i> : <i className="fa-solid fa-map-pin"></i>}
                                                </div>
                                                {s && <div className="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-green-700 bg-green-100 px-2 py-0.5 rounded-full whitespace-nowrap border border-green-300">ผ่านแล้ว</div>}
                                            </div>
                                        </div>
                                    );
                                })}

                                <div className="flex justify-center mt-12 mb-8 relative">
                                    <div className={`text-center p-6 rounded-3xl border-4 ${missionComplete ? 'bg-[#fffaf0] border-[#d4af37] shadow-[0_0_30px_rgba(212,175,55,0.4)] animate-pop-in' : 'bg-[#f4ebd0]/50 border-amber-900/20 grayscale opacity-50'}`}>
                                        <i className={`fa-solid fa-scroll text-6xl ${missionComplete ? 'text-[#d4af37] animate-float drop-shadow-lg' : 'text-amber-900/30'}`}></i>
                                        <h3 className={`font-black mt-4 ${missionComplete ? 'text-[#8b5a2b]' : 'text-amber-900/50'}`}>เกียรติบัตรผู้พิชิต</h3>
                                        {missionComplete ? (
                                            <button onClick={handleClaimCertificate} disabled={isGeneratingCert} className="mt-4 w-full treasure-btn text-white px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                                {isGeneratingCert ? <><i className="fa-solid fa-spinner fa-spin"></i> กำลังจารึกชื่อ...</> : <><i className="fa-solid fa-download"></i> รับเกียรติบัตร</>}
                                            </button>
                                        ) : (
                                            <p className="text-xs text-amber-900/50 mt-2 font-medium">สำรวจให้ครบทุกฐานเพื่อปลดล็อค</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="absolute bottom-6 w-full flex justify-center z-20">
                            <button onClick={()=>document.getElementById('qr-modal').classList.remove('hidden')} className="bg-[#8b5a2b] text-white px-8 py-4 rounded-full flex gap-3 font-bold shadow-[0_10px_20px_rgba(139,90,43,0.3)] hover:scale-105 transition border-2 border-[#5c3a21] items-center text-lg">
                                <i className="fa-solid fa-qrcode text-xl"></i> เปิดแผนที่ลับ (QR ของฉัน)
                            </button>
                        </div>

                        <div id="qr-modal" className="hidden absolute inset-0 bg-amber-950/90 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in" onClick={(e)=>{if(e.target.id==='qr-modal')e.target.classList.add('hidden')}}>
                            <div className="bg-[#fdf6e3] p-8 rounded-3xl text-center text-amber-950 w-80 relative border-4 border-[#8b5a2b] shadow-2xl map-bg">
                                <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-[#8b5a2b] text-white px-6 py-2 rounded-full font-black border-2 border-[#fdf6e3] shadow-lg">รหัสผ่านฐาน</div>
                                <h3 className="font-black mt-4 text-xl">{user.name}</h3>
                                <p className="text-sm font-bold text-amber-700 mb-6">PIN: <span className="text-xl">{user.pin}</span></p>
                                <div className="bg-white p-4 rounded-2xl shadow-inner border-2 border-amber-200 mb-6 relative">
                                    <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrPayload)}`} className="mx-auto" />
                                </div>
                                <p className="text-sm font-bold text-amber-800 bg-amber-100 p-3 rounded-xl border border-amber-200">
                                    <i className="fa-solid fa-camera-retro mr-2"></i>ยื่น QR Code นี้ให้สตาฟสแกน
                                </p>
                            </div>
                        </div>

                        {showCertModal && (
                            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/90 p-4 animate-fade-in">
                                <div className="bg-[#fdf6e3] rounded-3xl p-8 text-center text-amber-950 w-full max-w-sm relative shadow-2xl animate-pop-in border-4 border-[#d4af37]">
                                    <button onClick={()=>setShowCertModal(false)} className="absolute top-4 right-4 text-amber-900/50 hover:text-amber-900 bg-white w-8 h-8 rounded-full shadow"><i className="fa-solid fa-times"></i></button>
                                    <div className="text-6xl mb-4 text-[#d4af37] animate-float"><i className="fa-solid fa-award"></i></div>
                                    <h2 className="text-2xl font-black text-[#8b5a2b] mb-2">ยินดีด้วยผู้พิชิต!</h2>
                                    <p className="text-amber-800/80 mb-6 text-sm font-medium">คุณผ่านการทดสอบทั้งหมดแล้ว</p>
                                    <a href={certUrl} target="_blank" rel="noreferrer" className="w-full treasure-btn text-white px-6 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 mb-3">
                                        <i className="fa-solid fa-print"></i> เปิดดูเกียรติบัตร
                                    </a>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const StaffScan = () => {
                const [scanResult, setScanResult] = useState('');
                const [pendingPin, setPendingPin] = useState(null);
                const [localLoading, setLocalLoading] = useState(false);
                const scannerRef = useRef(null);

                useEffect(() => { 
                    const s = new Html5Qrcode("reader"); 
                    scannerRef.current = s; 
                    s.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScan, (e) => {}).catch(e=>{}); 
                    return () => { if(s.isScanning) s.stop(); }; 
                }, []);
                
                const onScan = (txt) => {
                    scannerRef.current.pause();
                    let extractPin = txt;
                    try {
                        if (txt.includes('pin=')) { const url = new URL(txt); extractPin = url.searchParams.get('pin'); } 
                        else { const d = JSON.parse(txt); extractPin = d.pin || d.id; }
                    } catch(e) {}
                    
                    if (extractPin && extractPin.length >= 4) { 
                        setPendingPin(extractPin); 
                    } else { 
                        setScanResult(`❌ รูปแบบ QR ไม่ถูกต้อง`); 
                        setTimeout(() => { setScanResult(''); if (scannerRef.current) scannerRef.current.resume(); }, 2000); 
                    }
                };

                const confirm = async () => {
                    setLocalLoading(true);
                    try {
                        const res = await apiCall('processScanAndGeneratePDF', { userPin: pendingPin, booth: staffData.name });
                        setLocalLoading(false); setPendingPin(null);
                        if(res.status === 'success') { 
                            setScanResult(`✅ บันทึกสำเร็จ!`); 
                        } else { 
                            setScanResult(`❌ ${res.message}`); 
                        }
                    } catch (error) {
                        setLocalLoading(false); setPendingPin(null);
                        setScanResult(`✅ บันทึกสำเร็จ (Demo)`); 
                    }
                    
                    setTimeout(()=>setScanResult(''), 3000); 
                    if (scannerRef.current) scannerRef.current.resume();
                };
                
                const handleCancel = () => { 
                    setPendingPin(null); 
                    if (scannerRef.current) scannerRef.current.resume(); 
                };

                return (
                    <div className="h-full bg-gray-900 flex flex-col relative text-white animate-slide-in">
                        <div className="p-4 bg-indigo-900 flex items-center justify-between shadow-lg z-10">
                            <div>
                                <div className="font-bold text-indigo-200 text-sm">จุดสแกนประจำฐาน</div>
                                <div className="text-xl font-black">{staffData ? staffData.name : 'โหลดข้อมูล...'}</div>
                            </div>
                            <button onClick={handleLogout} className="bg-white/20 p-2 rounded-full hover:bg-red-500 transition"><i className="fa-solid fa-power-off"></i></button>
                        </div>
                        
                        <div className="flex-1 flex flex-col p-6 relative">
                            {scanResult && <div className={`absolute top-6 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-full font-bold shadow-xl ${scanResult.includes('❌') ? 'bg-red-500' : 'bg-green-500'} text-white animate-pop-in`}>{scanResult}</div>}
                            
                            <div className="bg-black flex-1 rounded-3xl overflow-hidden relative border-4 border-indigo-500 shadow-[0_0_30px_rgba(99,102,241,0.3)]">
                                <div id="reader" className="w-full h-full"></div>
                                
                                {pendingPin && (
                                    <div className="absolute inset-0 bg-black/80 backdrop-blur flex flex-col items-center justify-center p-6 z-20 animate-fade-in">
                                        <div className="bg-indigo-900 p-6 rounded-3xl w-full max-w-xs text-center border-2 border-indigo-400">
                                            <i className="fa-solid fa-qrcode text-5xl mb-4 text-indigo-300"></i>
                                            <div className="text-sm text-indigo-200">รหัสผู้เข้าร่วม</div>
                                            <div className="text-3xl font-black text-white mb-6 tracking-widest">{pendingPin}</div>
                                            
                                            {localLoading ? (
                                                <div className="flex justify-center p-4"><i className="fa-solid fa-spinner fa-spin text-3xl text-indigo-400"></i></div>
                                            ) : (
                                                <div className="flex gap-3">
                                                    <button onClick={handleCancel} className="flex-1 bg-gray-700 py-3 rounded-xl font-bold">ยกเลิก</button>
                                                    <button onClick={confirm} className="flex-1 bg-green-500 py-3 rounded-xl font-bold">ยืนยัน</button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <p className="text-center mt-6 text-indigo-200 text-sm"><i className="fa-solid fa-crosshairs mr-2"></i>หันกล้องไปที่ QR Code ของผู้เข้าร่วม</p>
                        </div>
                    </div>
                );
            };

            // Main Render Logic
            if (view === 'staff') return <StaffScan />;
            if (view === 'student') return <StudentDashboard />;
            if (view === 'login-pin') return <PinPad onComplete={handlePinSubmit} onBack={() => setView('landing')} />;
            if (view === 'login-scan') return <LoginScanner />;
            if (view === 'register') return <Register />;
            return <Landing />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
